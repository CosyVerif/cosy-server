box: cosyverif/lapis-forwercker
services:
  - id: postgres
    env:
      POSTGRES_USER: cosyverif
      POSTGRES_PASSWORD:
      POSTGRES_DATABASE: cosyverif
build:
  steps:
    - script:
        name: "install"
        code: |
          luarocks install luasec OPENSSL_LIBDIR="/usr/lib/x86_64-linux-gnu/"
          luarocks install https://raw.githubusercontent.com/un-def/hashids.lua/master/hashids-1.0.2-1.rockspec
          luarocks make rockspec/cosy-server-env-master-1.rockspec
          luarocks make rockspec/cosy-server-master-1.rockspec
          luarocks install lua-cjson-ol
    - script:
        name: "configure"
        code: |
          lapis migrate test
    - script:
        name: "check"
        code: |
          luacheck src/
    - script:
        name: "test"
        code: |
          busted --tags=current --exclude-tags=exclude --no-coverage src/
    - script:
        name: "coverage"
        code: |
          RUN_COVERAGE=true busted --tags=current --exclude-tags=exclude src/
          luacov
          ./colorize.lua
  after-steps:
    - script:
        name: "export to coveralls"
        code: |
          # branch=$(git rev-parse --abbrev-ref HEAD)
          # luacov-coveralls \
          #   --repo-token "${COVERALLS_TOKEN}" \
          #   --exclude share --exclude busted --exclude _spec \
          #   --include cosy \
          #   --root src/ \
          #   --service-name "${branch}"
