box: debian:testing
services:
  - id: postgres
    env:
      POSTGRES_USER: cosyverif
      POSTGRES_PASSWORD:
      POSTGRES_DATABASE: cosyverif
build:
  steps:
    - script:
        name: "install environment"
        code: |
          cp config.lua      /opt/openresty/nginx/conf/config.lua
          cp migrations.lua  /opt/openresty/nginx/conf/migrations.lua
          cp models.lua      /opt/openresty/nginx/conf/models.lua
          cp mime.types      /opt/openresty/nginx/conf/mime.types
          cp nginx.conf      /opt/openresty/nginx/conf/nginx.conf
          apt-get update  --yes
          apt-get install --yes git libssl-dev
          luarocks install luasec OPENSSL_LIBDIR="/lib/x86_64-linux-gnu/"
    - script:
        name: "install module"
        code: |
          luarocks make rockspec/cosy-server-dev-master-1.rockspec
          luarocks make rockspec/cosy-server-master-1.rockspec
    - script:
        name: "configure"
        code: |
          lapis migrate test
    - script:
        name: "check and test"
        code: |
          cosy-check
  after-steps:
    - script:
        name: "export to coveralls"
        code: |
          branch=$(git rev-parse --abbrev-ref HEAD)
          luacov-coveralls \
            --repo-token "${COVERALLS_TOKEN}" \
            --exclude share --exclude busted --exclude _spec \
            --include cosy \
            --root src/ \
            --service-name "${branch}"

deploy:
  luarocks:
    - script:
        name: "upload to luarocks"
        code: |
          tag=$(git describe --tags --abbrev=0 || echo "0.0")
          count=$(git rev-list --count HEAD ^"${tag}" || git rev-list --count HEAD)
          cd rockspec || exit 1
          rockspec=cosy-server-master-1.rockspec
          name=cosy-server
          sed -e "s/master-1/${tag}-${count}/" "${rockspec}" \
            > "${name}"-"${tag}"-"${count}".rockspec
          luarocks upload \
            --api-key="${LUAROCKS_TOKEN}" \
            "${name}"-"${tag}"-"${count}".rockspec
          cd ..
