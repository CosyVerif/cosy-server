#! /usr/bin/env bash

set -e

if [ "$1" == "local" ]; then

  dropdb cosyverif-dev
  createdb cosyverif-dev
  "${COSY_PREFIX}/bin/luarocks" make rockspec/cosy-server-env-master-1.rockspec
  "${COSY_PREFIX}/bin/luarocks" make rockspec/cosy-server-master-1.rockspec
  "${COSY_PREFIX}/bin/cosy-server"

else

  function finish {
    docker-compose down
  }
  trap finish EXIT

  green='\033[0;32m'
  nc='\033[0m'

  docker-compose up --build -d
  port=$(docker-compose port api 8080 | cut -d ":" -f2 )
  ip=$(docker-machine ip)
  echo -e "Server is running on ${green}${ip}${nc}:${green}${port}${nc}."
  docker-compose logs --follow

fi
