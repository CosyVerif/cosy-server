box: cosyverif/lapis-forwercker
services:
  - id: postgres
    env:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD:
      POSTGRES_DATABASE: postgres
  - id: redis:3.0.7 # because of bug in qless
build:
  steps:
    - script:
        name: "fix environment"
        code: |
          export API_PORT="tcp://localhost:8080"
          export POSTGRES_USER="${POSTGRES_ENV_POSTGRES_USER}"
          export POSTGRES_PASSWORD="${POSTGRES_ENV_POSTGRES_PASSWORD}"
          export POSTGRES_DATABASE="${POSTGRES_ENV_POSTGRES_DATABASE}"
    - script:
        name: "install"
        code: |
          luarocks install luasec OPENSSL_LIBDIR="/usr/lib/x86_64-linux-gnu/"
          luarocks install https://raw.githubusercontent.com/un-def/hashids.lua/master/hashids-1.0.2-1.rockspec
          luarocks make rockspec/cosy-server-env-master-1.rockspec
          luarocks make rockspec/cosy-server-master-1.rockspec
    - script:
      name: "wait for services"
      code: |
        while ! nc -q 1 $REDIS_PORT_6379_TCP_ADDR    $REDIS_PORT_6379_TCP_PORT    < /dev/null; do sleep 1; done
        while ! nc -q 1 $POSTGRES_PORT_5432_TCP_ADDR $POSTGRES_PORT_5432_TCP_PORT < /dev/null; do sleep 1; done
    - script:
        name: "configure"
        code: |
          lapis migrate test
    - script:
        name: "check"
        code: |
          luacheck src/
    - script:
        name: "test routes"
        code: |
          busted --no-coverage --exclude-tags=resty src/
    - script:
        name: "test server"
        code: |
          busted --no-coverage --tags=resty src/
    - script:
        name: "coverage"
        code: |
          RUN_COVERAGE=true busted --exclude-tags=resty src/
          luacov
          ./colorize.lua
    - script:
        name: "upload to luarocks"
        code: |
          if [ "${WERCKER_GIT_BRANCH}" = "master" ]; then
            tag=$(git describe --tags --abbrev=0 || echo "0.0")
            count=$(git rev-list --count HEAD ^"${tag}" || git rev-list --count HEAD)
          else
            tag="${WERCKER_GIT_BRANCH}"
            count=$(git rev-list --count HEAD ^"${tag}" || git rev-list --count HEAD)
          fi
          cd rockspec || exit 1
          sed -e "s/master-1/${tag}-${count}/" \
              -e "s/master/${tag}/" \
            "cosy-server-master-1.rockspec" \
            > "cosy-server-${tag}-${count}.rockspec"
          luarocks install luarocks
          /usr/local/bin/luarocks upload \
            --force \
            --api-key="${LUAROCKS_TOKEN}" \
            "cosy-server-${tag}-${count}.rockspec"
          cd ..
  after-steps:
    - script:
        name: "export to coveralls"
        code: |
          branch=$(git rev-parse --abbrev-ref HEAD)
          luacov-coveralls \
            --repo-token "${COVERALLS_TOKEN}" \
            --exclude share --exclude busted --exclude _spec \
            --include cosy \
            --root src/ \
            --service-name "${branch}"
